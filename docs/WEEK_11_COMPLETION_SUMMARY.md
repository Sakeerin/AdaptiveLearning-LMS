# Week 11 Completion Summary: Gamification

## Overview

Week 11 implements a comprehensive gamification system to increase learner engagement and motivation. The system includes XP (experience points), levels, points, achievements/badges, streaks, and leaderboards.

## Implementation Details

### 1. Database Models

#### Achievement Model
**File:** `packages/api/src/models/Achievement.ts`

Defines achievements/badges that users can earn:
- **Types**: `badge`, `milestone`, `streak`, `mastery`
- **Criteria**: Configurable thresholds for different metrics
- **Rewards**: XP and points awarded when earned
- **Tiers**: Bronze, Silver, Gold, Platinum
- **Bilingual**: Thai and English names/descriptions

**Schema:**
```typescript
{
  key: string (unique identifier)
  type: 'badge' | 'milestone' | 'streak' | 'mastery'
  name: { th: string, en: string }
  description: { th: string, en: string }
  icon: string (emoji or icon identifier)
  criteria: {
    metric: 'xp' | 'lessons_completed' | 'quizzes_passed' | 'streak_days' | 'mastery_avg' | 'perfect_quizzes'
    threshold: number
    timeframe?: 'daily' | 'weekly' | 'monthly' | 'all-time'
  }
  reward: { xp: number, points: number }
  tier?: 'bronze' | 'silver' | 'gold' | 'platinum'
  isActive: boolean
}
```

#### UserAchievement Model
**File:** `packages/api/src/models/UserAchievement.ts`

Tracks achievements earned by users:
- Links user to achievement
- Records when earned
- Tracks progress toward achievement (0-100%)
- Notification status

**Unique constraint:** `(userId, achievementId)` prevents duplicate earnings

#### UserGameStats Model
**File:** `packages/api/src/models/UserGameStats.ts`

Central gamification stats for each user:
- **XP and Level**: Quadratic progression formula
- **Points**: Separate currency for rewards
- **Streak**: Current and longest streaks
- **Stats**: Lessons completed, quizzes passed, perfect quizzes, study time, average mastery

**Level Formula:**
```
Level = floor(sqrt(XP / 100)) + 1

Level 1: 0-99 XP
Level 2: 100-399 XP
Level 3: 400-899 XP
Level 4: 900-1599 XP
...
```

**Methods:**
- `addXP(amount)`: Add XP and auto-update level
- `updateStreak()`: Update daily streak (increments on consecutive days, resets on break)
- `calculateLevel(xp)`: Static method to calculate level from XP
- `xpForNextLevel(level)`: Static method to calculate XP needed for next level

#### LeaderboardEntry Model
**File:** `packages/api/src/models/Leaderboard.ts`

Stores leaderboard rankings for different periods:
- **Scope**: `global` or `course` specific
- **Metric**: `xp`, `points`, `streak`, or `mastery`
- **Period**: `daily`, `weekly`, `monthly`, or `all-time`
- **Rank**: User's position in leaderboard
- **Value**: Metric value for the period

**Note:** For `all-time` leaderboards, data is computed directly from UserGameStats. For time-bound periods, entries should be generated by a scheduled job (not implemented in this week).

### 2. Gamification Service

**File:** `packages/api/src/services/gamification.service.ts`

Core gamification logic:

#### XP and Points Rewards

```typescript
XP_REWARDS = {
  LESSON_COMPLETED: 50,
  QUIZ_PASSED: 100,
  QUIZ_PERFECT: 150,
  FIRST_LESSON: 25,
  DAILY_LOGIN: 10,
  STREAK_BONUS_PER_DAY: 5
}

POINTS_REWARDS = {
  LESSON_COMPLETED: 10,
  QUIZ_PASSED: 20,
  QUIZ_PERFECT: 30,
  ACHIEVEMENT_EARNED: 50
}
```

#### Key Functions

**`initializeUserGameStats(userId)`**
- Creates initial game stats for new users
- Idempotent (safe to call multiple times)

**`awardXPAndPoints(userId, xp, points, reason)`**
- Awards XP and points to user
- Automatically updates level if XP threshold crossed
- Returns: `{ newXP, newLevel, leveledUp, newPoints }`

**`updateUserStreak(userId)`**
- Updates daily streak tracking
- Awards bonus XP for consecutive days
- Resets streak if activity gap > 1 day
- Returns: `{ current, longest, updated }`

**`handleLessonCompletion(userId, lessonId, timeSpent)`**
- Called when lesson is completed
- Awards XP and points
- Updates stats (lessons completed, total study time)
- Updates streak
- Checks for new achievements
- Returns: `{ xp, points, achievements }`

**`handleQuizCompletion(userId, quizId, passed, isPerfect)`**
- Called when quiz is submitted
- Awards XP and points (only if passed)
- Updates stats (quizzes passed, perfect quizzes)
- Updates streak
- Checks for new achievements
- Returns: `{ xp, points, achievements }`

**`checkAndAwardAchievements(userId)`**
- Checks all active achievements against user's stats
- Awards newly earned achievements
- Awards achievement rewards (XP + points)
- Returns: Array of newly earned achievements

**`getUserGameStats(userId)`**
- Gets complete game stats for user
- Calculates average mastery from competencies
- Calculates XP progress toward next level
- Returns: Full stats object with level progress

**`getUserAchievements(userId)`**
- Gets all achievements earned by user
- Sorted by earned date (most recent first)
- Populated with full achievement details

**`getLeaderboard(metric, period, limit, courseId?)`**
- Gets leaderboard for specified metric and period
- For `all-time`: Computed directly from UserGameStats
- For time-bound periods: Retrieved from LeaderboardEntry
- Supports both global and course-specific leaderboards
- Returns: Ranked list of users with values

**`getUserRank(userId, metric, period)`**
- Gets user's rank for specified metric
- Counts users with higher values
- Returns: `{ rank, value, total }`

### 3. API Routes

#### Public Gamification Routes
**File:** `packages/api/src/routes/gamification.ts`

All routes require authentication.

##### GET `/api/gamification/stats`
Get current user's game stats.

**Response:**
```json
{
  "userId": "...",
  "xp": 1500,
  "level": 5,
  "xpForNextLevel": 2500,
  "xpProgress": 1000,
  "points": 350,
  "streak": {
    "current": 7,
    "longest": 12,
    "lastActivityDate": "2024-01-08T00:00:00.000Z"
  },
  "stats": {
    "lessonsCompleted": 25,
    "quizzesPassed": 10,
    "perfectQuizzes": 3,
    "totalStudyTime": 7200000,
    "averageMastery": 0.75
  }
}
```

##### GET `/api/gamification/achievements`
Get current user's earned achievements.

**Response:**
```json
[
  {
    "achievement": {
      "_id": "...",
      "key": "lessons_5",
      "type": "badge",
      "name": { "th": "‡∏Å‡πâ‡∏≤‡∏ß‡πÅ‡∏£‡∏Å", "en": "First Steps" },
      "description": { "th": "‡∏à‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "en": "Complete 5 lessons" },
      "icon": "üìö",
      "tier": "bronze"
    },
    "earnedAt": "2024-01-08T10:30:00.000Z",
    "progress": 100
  }
]
```

##### GET `/api/gamification/leaderboard`
Get leaderboard.

**Query Parameters:**
- `metric`: `'xp'` | `'points'` | `'streak'` (default: `'xp'`)
- `period`: `'daily'` | `'weekly'` | `'monthly'` | `'all-time'` (default: `'all-time'`)
- `limit`: Number (default: 100, max: 500)
- `courseId`: Optional course filter

**Response:**
```json
{
  "metric": "xp",
  "period": "all-time",
  "courseId": null,
  "entries": [
    {
      "rank": 1,
      "user": {
        "_id": "...",
        "name": "John Doe",
        "email": "john@example.com",
        "profilePicture": "..."
      },
      "value": 15000,
      "level": 13
    }
  ]
}
```

##### GET `/api/gamification/rank`
Get current user's rank in leaderboard.

**Query Parameters:**
- `metric`: `'xp'` | `'points'` | `'streak'` (default: `'xp'`)

**Response:**
```json
{
  "metric": "xp",
  "rank": 42,
  "value": 3500,
  "total": 500
}
```

##### POST `/api/gamification/initialize`
Initialize game stats for current user (idempotent).

**Response:**
```json
{
  "userId": "...",
  "xp": 0,
  "level": 1,
  "points": 0,
  "streak": { "current": 0, "longest": 0 },
  "stats": {
    "lessonsCompleted": 0,
    "quizzesPassed": 0,
    "perfectQuizzes": 0,
    "totalStudyTime": 0,
    "averageMastery": 0
  }
}
```

#### Admin Achievement Routes
**File:** `packages/api/src/routes/admin/achievements.ts`

All routes require admin/instructor role.

##### GET `/api/admin/achievements`
Get all achievements.

**Query Parameters:**
- `type`: Filter by type (`'badge'` | `'milestone'` | `'streak'` | `'mastery'`)
- `isActive`: Filter by active status (`'true'` | `'false'`)

##### GET `/api/admin/achievements/:id`
Get achievement by ID with statistics.

**Response includes:**
- Full achievement details
- `earnedCount`: Number of users who earned it

##### POST `/api/admin/achievements`
Create new achievement.

**Body:**
```json
{
  "key": "custom_achievement",
  "type": "badge",
  "name": { "th": "...", "en": "..." },
  "description": { "th": "...", "en": "..." },
  "icon": "üèÜ",
  "criteria": {
    "metric": "lessons_completed",
    "threshold": 50
  },
  "reward": { "xp": 500, "points": 250 },
  "tier": "silver",
  "isActive": true
}
```

##### PUT `/api/admin/achievements/:id`
Update achievement.

**Note:** Cannot change `key` if achievement has been earned by any user.

##### DELETE `/api/admin/achievements/:id`
Soft delete achievement (sets `isActive` to false).

##### GET `/api/admin/achievements/:id/users`
Get users who earned this achievement.

**Query Parameters:**
- `limit`: Number (default: 50, max: 500)
- `offset`: Number (default: 0)

**Response:**
```json
{
  "achievement": { ... },
  "users": [
    {
      "user": { "_id": "...", "name": "...", "email": "..." },
      "earnedAt": "2024-01-08T10:30:00.000Z",
      "progress": 100
    }
  ],
  "total": 150,
  "limit": 50,
  "offset": 0
}
```

### 4. Integration with Other Systems

#### Quiz Completion Integration
**File:** `packages/api/src/services/quiz-grading.service.ts`

The `gradeQuiz` function now:
1. Grades quiz responses
2. **Calls `handleQuizCompletion`** to award gamification rewards
3. Returns gamification result in response

**Updated Response:**
```json
{
  "score": { ... },
  "responses": [ ... ],
  "passed": true,
  "gamification": {
    "xp": 150,
    "points": 30,
    "achievements": [
      { "achievement": { ... }, "earnedAt": "..." }
    ]
  }
}
```

#### Lesson Completion Integration
**File:** `packages/api/src/routes/adaptive.ts`

The `POST /api/users/:userId/lessons/:lessonId/complete` endpoint now:
1. Marks lesson as completed
2. **Calls `handleLessonCompletion`** to award gamification rewards
3. Returns gamification result in response

**Updated Response:**
```json
{
  "message": "Lesson marked as completed",
  "progress": { ... },
  "gamification": {
    "xp": 75,
    "points": 10,
    "achievements": [ ... ]
  }
}
```

### 5. Default Achievements

**File:** `packages/api/src/seeds/achievements.seed.ts`

Provides 20 default achievements across 4 categories:

#### XP Milestones (4 achievements)
- ü•â Novice Learner (1,000 XP)
- ü•à Smart Learner (5,000 XP)
- ü•á Expert Learner (10,000 XP)
- üíé Master Learner (25,000 XP)

#### Lesson Completion (3 achievements)
- üìö First Steps (5 lessons)
- üìñ Avid Reader (25 lessons)
- üêõ Bookworm (100 lessons)

#### Quiz Performance (5 achievements)
- ‚úÖ Quiz Taker (5 quizzes passed)
- üéØ Quiz Expert (25 quizzes passed)
- üíØ Perfect Score (1 perfect quiz)
- üåü Perfectionist (10 perfect quizzes)

#### Streak (4 achievements)
- üî• Good Habit (3 days)
- üî•üî• Week of Dedication (7 days)
- üî•üî•üî• Month of Mastery (30 days)
- üí™ Unstoppable (100 days)

#### Mastery (3 achievements)
- üìä Solid Student (50% avg mastery)
- üìà Proficient (75% avg mastery)
- üéì Master (90% avg mastery)

**Running the seed:**
```bash
cd packages/api
npm run seed:achievements
# OR
npx ts-node src/seeds/achievements.seed.ts
```

## API Endpoints Summary

### Public Endpoints (Authenticated Users)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/gamification/stats` | Get user's game stats |
| GET | `/api/gamification/achievements` | Get user's earned achievements |
| GET | `/api/gamification/leaderboard` | Get leaderboard |
| GET | `/api/gamification/rank` | Get user's rank |
| POST | `/api/gamification/initialize` | Initialize game stats |

**Total: 5 endpoints**

### Admin Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/admin/achievements` | List all achievements |
| GET | `/api/admin/achievements/:id` | Get achievement details |
| POST | `/api/admin/achievements` | Create achievement |
| PUT | `/api/admin/achievements/:id` | Update achievement |
| DELETE | `/api/admin/achievements/:id` | Delete achievement |
| GET | `/api/admin/achievements/:id/users` | Get users who earned achievement |

**Total: 6 endpoints**

**Grand Total: 11 new endpoints**

## Testing Examples

### Get User Stats
```bash
curl -X GET "http://localhost:3001/api/gamification/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Get Leaderboard
```bash
curl -X GET "http://localhost:3001/api/gamification/leaderboard?metric=xp&period=all-time&limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Get User Achievements
```bash
curl -X GET "http://localhost:3001/api/gamification/achievements" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Create Achievement (Admin)
```bash
curl -X POST "http://localhost:3001/api/admin/achievements" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "speed_demon",
    "type": "badge",
    "name": { "th": "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß", "en": "Speed Demon" },
    "description": { "th": "‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏¥‡∏ã‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ", "en": "Complete a quiz in 30 seconds" },
    "icon": "‚ö°",
    "criteria": {
      "metric": "quizzes_passed",
      "threshold": 1
    },
    "reward": { "xp": 200, "points": 100 },
    "tier": "bronze",
    "isActive": true
  }'
```

## Configuration

### Environment Variables

No new environment variables required. Gamification works out of the box with existing MongoDB connection.

### Feature Flags

To disable gamification rewards temporarily without code changes, you could:
1. Set all achievements to `isActive: false`
2. Add a feature flag in environment variables (not implemented in this week)

## Technical Decisions

### 1. Level Progression Formula

**Chosen:** Quadratic progression (`level = floor(sqrt(xp / 100)) + 1`)

**Rationale:**
- Provides diminishing difficulty (early levels faster, later levels slower)
- Mathematically elegant and invertible
- Common in RPG systems (e.g., Pok√©mon)
- Level 1-10 achievable with reasonable effort
- Level 20+ requires significant dedication

### 2. Separate XP and Points

**Rationale:**
- XP: Represents overall progress, cannot be spent
- Points: Secondary currency for future reward shop (not implemented)
- Provides dual progression systems for variety

### 3. Streak Bonus

**Formula:** `bonusXP = currentStreak * 5`

**Rationale:**
- Incentivizes daily engagement
- Linear scaling to avoid extreme advantages
- Capped by natural human limits (365 days max = 1,825 bonus XP)

### 4. All-or-Nothing Multi-Select Grading

**Rationale:**
- Maintains consistency with Week 6 quiz grading
- Prevents partial credit gaming
- Clear success criteria

### 5. Async Gamification Rewards

**Rationale:**
- Doesn't block quiz/lesson completion responses
- Errors in gamification don't fail core operations
- Improves perceived performance

### 6. Leaderboard Implementation

**For all-time period:** Direct query from UserGameStats (real-time)

**For time-bound periods:** Pre-computed LeaderboardEntry (requires cron job)

**Rationale:**
- All-time leaderboards are most common and must be real-time
- Time-bound leaderboards can be cached for performance
- Cron job implementation deferred to Week 13 (Analytics & Notifications)

## Limitations and Future Enhancements

### Current Limitations

1. **No Time-bound Leaderboards**: Daily/weekly/monthly leaderboards require a scheduled job to compute LeaderboardEntry records. Currently returns empty for these periods.

2. **No Achievement Progress Tracking**: Achievement progress is binary (earned or not). Partial progress (e.g., "3/5 lessons completed") not shown in UI.

3. **No Reward Shop**: Points system exists but cannot be spent yet. Reward shop would be a future enhancement.

4. **No Social Features**: No friend leaderboards, no achievement sharing, no user profiles.

5. **No Badge Display Order**: Achievements sorted by earned date only. No pinning or custom ordering.

6. **No Level Rewards**: Leveling up gives satisfaction but no tangible rewards. Could award points or achievements.

### Future Enhancements (Post-Week 11)

1. **Scheduled Leaderboard Updates**: Cron job to compute time-bound leaderboards (Week 13)

2. **Achievement Notifications**: Push/email notifications when achievements earned (Week 13)

3. **Reward Shop**: Spend points on cosmetic items, avatar customization, power-ups

4. **Social Features**: Friend lists, challenge friends, share achievements

5. **Advanced Achievements**: Time-based (speed run), combo-based (perfect streak), hidden achievements

6. **Level Rewards**: Award points, unlock features, or grant special badges at milestone levels

7. **Achievement Categories**: Filter by category, track completion percentage per category

8. **Leaderboard Filters**: Filter by cohort, class, or custom groups

9. **Gamification Analytics**: Track engagement metrics, achievement rarity, optimal reward values

10. **Custom User Titles**: Unlock titles based on achievements (e.g., "Master of Python")

## Database Indexes

All indexes created automatically via model schemas:

**Achievement:**
- `key` (unique)
- `(type, isActive)`
- `criteria.metric`

**UserAchievement:**
- `(userId, achievementId)` (unique)
- `userId`
- `achievementId`
- `(userId, earnedAt)` (descending)

**UserGameStats:**
- `userId` (unique)
- `xp` (descending)
- `points` (descending)
- `streak.current` (descending)
- `level` (descending)

**LeaderboardEntry:**
- `(scope, metric, period, rank)`
- `(scope, courseId, metric, period, rank)`
- `(userId, scope, metric, period)`
- `periodEnd` (for cleanup)
- `(userId, scope, courseId, metric, period, periodStart)` (unique)

## Performance Considerations

1. **Achievement Checking**: Runs on every lesson/quiz completion. With 20 default achievements, performance impact is minimal. With 100+ achievements, consider:
   - Caching user's earned achievement IDs in memory
   - Filtering achievements by type before checking
   - Batch updates instead of per-event checks

2. **Leaderboard Queries**: All-time leaderboards query entire UserGameStats collection. For large user bases (>100k), consider:
   - Caching top 100 for 5-10 minutes
   - Using MongoDB aggregation pipeline with $facet
   - Pre-computing all-time leaderboards nightly

3. **Mastery Calculation**: Average mastery computed on every stats request. Consider:
   - Caching in UserGameStats (update on mastery changes)
   - Computing asynchronously
   - Using MongoDB aggregation

4. **Streak Updates**: Safe to call multiple times per day (idempotent). No optimization needed.

## Security Considerations

1. **Authorization**: All endpoints verify user identity via JWT authentication
2. **Admin Routes**: Achievement management restricted to admin/instructor roles
3. **User Isolation**: Users can only access their own stats/achievements (except leaderboards)
4. **Input Validation**: All inputs validated for type, range, and required fields
5. **Rate Limiting**: Consider adding rate limits on leaderboard endpoints (not implemented)
6. **Leaderboard Privacy**: All users visible in leaderboards. Future enhancement: opt-in/opt-out system

## Files Created/Modified

### New Files (10)
1. `packages/api/src/models/Achievement.ts` - Achievement definition model
2. `packages/api/src/models/UserAchievement.ts` - User achievement tracking
3. `packages/api/src/models/UserGameStats.ts` - User game statistics
4. `packages/api/src/models/Leaderboard.ts` - Leaderboard entry model
5. `packages/api/src/services/gamification.service.ts` - Core gamification logic
6. `packages/api/src/routes/gamification.ts` - Public API routes
7. `packages/api/src/routes/admin/achievements.ts` - Admin API routes
8. `packages/api/src/seeds/achievements.seed.ts` - Default achievements seed
9. `docs/WEEK_11_COMPLETION_SUMMARY.md` - This document

### Modified Files (2)
1. `packages/api/src/services/quiz-grading.service.ts` - Added gamification integration
2. `packages/api/src/routes/adaptive.ts` - Added gamification integration

### Already Registered
- `packages/api/src/index.ts` - Gamification routes already registered from stub

## Completion Status

‚úÖ **Achievement and Badge Models** - Created with full bilingual support
‚úÖ **UserGameStats Model** - XP, levels, points, streaks, stats tracking
‚úÖ **Leaderboard Model** - Multi-period, multi-metric support
‚úÖ **Gamification Service** - Complete reward logic and achievement checking
‚úÖ **Public API Routes** - 5 endpoints for user gamification features
‚úÖ **Admin API Routes** - 6 endpoints for achievement management
‚úÖ **Quiz Integration** - Automatic rewards on quiz completion
‚úÖ **Lesson Integration** - Automatic rewards on lesson completion
‚úÖ **Default Achievements** - 20 achievements across 4 categories
‚úÖ **Documentation** - Complete technical documentation

**Week 11: Gamification is complete!** üéÆüèÜ

## Next Steps

To use the gamification system:

1. **Seed Default Achievements:**
   ```bash
   cd packages/api
   npx ts-node src/seeds/achievements.seed.ts
   ```

2. **Initialize User Stats:**
   - Stats are auto-created on first event (lesson/quiz completion)
   - Or manually: `POST /api/gamification/initialize`

3. **Complete Lessons/Quizzes:**
   - Rewards automatically awarded
   - Achievements checked and granted
   - Streaks updated daily

4. **View Progress:**
   - Check stats: `GET /api/gamification/stats`
   - View achievements: `GET /api/gamification/achievements`
   - See leaderboard: `GET /api/gamification/leaderboard`

5. **Manage Achievements (Admin):**
   - Create custom achievements via admin endpoints
   - Monitor user progress
   - Adjust rewards as needed

Week 12 (Mobile Offline Sync) coming next!
